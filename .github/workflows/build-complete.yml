name: Build Mull using FDroidServer

on:
  workflow_dispatch:
    inputs:
      version_code:
        description: 'Version code to build (e.g., 2291052 for arm64)'
        required: true
        default: '2291052'
        type: string
      architecture:
        description: 'Target architecture'
        required: false
        default: 'arm64'
        type: choice
        options:
        - arm64
        - armv7
        - x86

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6小时超时

    steps:
    - name: Maximize build space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h

    - name: Checkout Mull-Fenix
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 python3-pip python3-venv \
          git mercurial subversion \
          openjdk-17-jdk-headless \
          build-essential \
          rsync \
          unzip

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install fdroidserver
      run: |
        python3 -m venv fdroid-env
        source fdroid-env/bin/activate
        pip install fdroidserver
        
        # 验证安装
        fdroid --version

    - name: Setup fdroid environment
      run: |
        source fdroid-env/bin/activate
        
        # 创建 fdroid 工作目录
        mkdir -p fdroid-build
        cd fdroid-build
        
        echo "=== Initializing fdroid repository ==="
        fdroid init --verbose
        
        echo "=== Cloning fdroiddata for Mull configs ==="
        git clone https://gitlab.com/fdroid/fdroiddata.git
        
        # 查找 Mull 相关的配置文件
        echo "=== Looking for Mull configuration ==="
        find fdroiddata -name "*fennec*" -o -name "*mull*" -o -name "*spotco*" | head -10

    - name: Prepare Mull build configuration
      run: |
        source fdroid-env/bin/activate
        cd fdroid-build
        
        # 查找正确的应用 ID 和配置
        echo "=== Searching for Mull app configuration ==="
        find fdroiddata -name "*.yml" -exec grep -l "spotco\|fennec_dos\|Mull" {} \;
        
        # 复制 Mull 配置到 fdroid metadata
        MULL_CONFIG=$(find fdroiddata -name "*.yml" -exec grep -l "us.spotco.fennec_dos\|Mull" {} \; | head -1)
        if [ -n "$MULL_CONFIG" ]; then
          echo "Found Mull config: $MULL_CONFIG"
          cp "$MULL_CONFIG" metadata/
          
          # 显示配置内容
          echo "=== Mull build configuration ==="
          cat "$MULL_CONFIG"
        else
          echo "Mull config not found in fdroiddata, creating basic config..."
          
          # 创建基本的 Mull 配置
          cat > metadata/us.spotco.fennec_dos.yml << 'EOF'
Categories:
  - Internet
License: MPL-2.0
AuthorName: Divested Computing Group
AuthorWebSite: https://divestos.org
WebSite: https://divestos.org/pages/our_apps#mull
SourceCode: https://codeberg.org/divested-mobile/mull-fenix
IssueTracker: https://codeberg.org/divested-mobile/mull-fenix/issues

AutoName: Mull
Summary: Privacy oriented web browser
Description: |-
    Privacy oriented web browser based on Firefox. Removes proprietary blobs and enables many features from Tor Uplift project.

RepoType: git
Repo: https://codeberg.org/divested-mobile/mull-fenix.git

Builds:
  - versionName: '129.0'
    versionCode: ${{ github.event.inputs.version_code }}
    commit: HEAD
    timeout: 21600
    sudo:
      - apt-get update
      - apt-get install -y mercurial
    gradle:
      - yes
    prebuild: |
      # Mull specific prebuild steps would go here
    build: |
      # Custom build script for Mull
      echo "Building Mull with fdroidserver"

AutoUpdateMode: None
UpdateCheckMode: None
CurrentVersion: '129.0'
CurrentVersionCode: ${{ github.event.inputs.version_code }}
EOF
        fi

    - name: Build Mull APK
      run: |
        source fdroid-env/bin/activate
        cd fdroid-build
        
        echo "=== Starting fdroid build process ==="
        echo "Version code: ${{ github.event.inputs.version_code }}"
        echo "Architecture: ${{ github.event.inputs.architecture }}"
        
        # 构建 Mull
        fdroid build -v -l us.spotco.fennec_dos:${{ github.event.inputs.version_code }} || {
          echo "=== Build failed, checking logs ==="
          find . -name "*.log" -newer metadata -exec echo "=== {} ===" \; -exec tail -100 {} \;
          
          echo "=== Checking build directory ==="
          find . -name "*mull*" -o -name "*fennec*" -o -name "*.apk"
          exit 1
        }

    - name: Find and prepare APKs
      id: find_apk
      run: |
        cd fdroid-build
        
        echo "=== Searching for built APKs ==="
        find . -name "*.apk" -type f
        
        APK_PATH=$(find . -name "*.apk" -type f | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "No APK found!"
          exit 1
        fi
        
        echo "Found APK: $APK_PATH"
        
        # 复制 APK 到工作目录
        cp "$APK_PATH" ../mull-${{ github.event.inputs.architecture }}-$(date +%Y%m%d).apk
        echo "apk_name=mull-${{ github.event.inputs.architecture }}-$(date +%Y%m%d).apk" >> $GITHUB_OUTPUT

    - name: Check signing secrets
      id: check_secrets
      run: |
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ] && [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_PASSWORD }}" ] && [ -n "${{ secrets.KEY_ALIAS }}" ]; then
          echo "signing_enabled=true" >> $GITHUB_OUTPUT
        else
          echo "signing_enabled=false" >> $GITHUB_OUTPUT
          echo "Warning: Signing secrets not complete, will skip APK signing"
        fi

    - name: Decode signing keystore
      if: steps.check_secrets.outputs.signing_enabled == 'true'
      run: |
        mkdir -p keystore
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore/keystore.jks

    - name: Sign APK
      if: steps.check_secrets.outputs.signing_enabled == 'true'
      run: |
        APK_NAME="${{ steps.find_apk.outputs.apk_name }}"
        
        # 安装 Android SDK build tools (for zipalign)
        sudo apt-get install -y android-sdk-build-tools
        
        # 对齐APK
        zipalign -v 4 "$APK_NAME" "${APK_NAME%.apk}-aligned.apk"
        
        # 签名APK
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore keystore/keystore.jks \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -keypass "${{ secrets.KEY_PASSWORD }}" \
          "${APK_NAME%.apk}-aligned.apk" "${{ secrets.KEY_ALIAS }}"
        
        # 验证签名
        jarsigner -verify -verbose "${APK_NAME%.apk}-aligned.apk"
        
        mv "${APK_NAME%.apk}-aligned.apk" "${APK_NAME%.apk}-signed.apk"

    - name: Upload unsigned APK
      uses: actions/upload-artifact@v4
      with:
        name: mull-unsigned-${{ github.event.inputs.architecture }}
        path: "*.apk"
        retention-days: 30

    - name: Upload signed APK
      if: steps.check_secrets.outputs.signing_enabled == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: mull-signed-${{ github.event.inputs.architecture }}
        path: "*-signed.apk"
        retention-days: 90

    - name: Build summary
      run: |
        echo "## Mull Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Build method: fdroidserver (official method)" >> $GITHUB_STEP_SUMMARY
        echo "- Version code: ${{ github.event.inputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- Architecture: ${{ github.event.inputs.architecture }}" >> $GITHUB_STEP_SUMMARY
        echo "- APK name: ${{ steps.find_apk.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Architecture codes:" >> $GITHUB_STEP_SUMMARY
        echo "- ARMv7: version code ending in 0" >> $GITHUB_STEP_SUMMARY
        echo "- x86: version code ending in 1" >> $GITHUB_STEP_SUMMARY  
        echo "- AArch64: version code ending in 2" >> $GITHUB_STEP_SUMMARY
        ls -la *.apk >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No APK files found" >> $GITHUB_STEP_SUMMARY
